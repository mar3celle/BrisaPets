<!DOCTYPE html>
<html lang="pt-PT" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brisa Pets - Admin Agendamentos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/booking.css">
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="p-6">
            <h1><i class="fas fa-heart"></i> Brisa Pets <span class="logo-sub">Admin</span></h1>
            <nav>
                <a href="/admin" class="sidebar-item" th:classappend="${currentPage == 'admin'} ? 'active' : ''" id="nav-dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/reports" class="sidebar-item" th:classappend="${currentPage == 'reports'} ? 'active' : ''" id="nav-reports">
                    <i class="fas fa-file-alt"></i> Relatórios
                </a>
                <a href="/clientlist" class="sidebar-item" th:classappend="${currentPage == 'clientlist'} ? 'active' : ''" id="nav-clients">
                    <i class="fas fa-users"></i> Clientes
                </a>
                <a href="/adminCalendar" class="sidebar-item" th:classappend="${currentPage == 'adminCalendar'} ? 'active' : ''" id="nav-adminCalendar">
                    <i class="fas fa-calendar-alt"></i> Agendamentos
                </a>
            </nav>
        </div>
    </aside>

    <div class="main-wrapper">
        <h1 id="page-title">Gestão de Agendamentos</h1>
        
        <div th:if="${adminMessage}" class="alert alert-success" style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
            <span th:text="${adminMessage}"></span>
        </div>
        <div th:if="${adminError}" class="alert alert-danger" style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
            <span th:text="${adminError}"></span>
        </div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Calendário de Agendamentos</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="generateReport('pdf')" class="btn" style="background: #dc3545; color: white;">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </button>
                    <button onclick="generateReport('excel')" class="btn" style="background: #28a745; color: white;">
                        <i class="fas fa-file-excel"></i> Gerar Excel
                    </button>
                    <button onclick="showAppointmentForm()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Agendamento
                    </button>
                </div>
            </div>
            
            <div class="calendar-header">
                <a th:href="@{/adminCalendar(year=${prevMonthYear}, month=${prevMonth})}">
                    <button type="button" class="nav-button"><i class="fas fa-chevron-left"></i></button>
                </a>
                <div class="month-year" th:text="${#temporals.format(currentYearMonth.atDay(1), 'MMMM yyyy')}">Novembro 2025</div>
                <a th:href="@{/adminCalendar(year=${nextMonthYear}, month=${nextMonth})}">
                    <button type="button" class="nav-button"><i class="fas fa-chevron-right"></i></button>
                </a>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <span class="day-name">Dom</span>
                <span class="day-name">Seg</span>
                <span class="day-name">Ter</span>
                <span class="day-name">Qua</span>
                <span class="day-name">Qui</span>
                <span class="day-name">Sex</span>
                <span class="day-name">Sáb</span>

                <th:block th:each="day : ${calendarDays}">
                    <span th:if="${day == null}"></span>
                    <th:block th:if="${day != null}">
                        <div class="calendar-day" 
                             th:attr="data-date-value=${currentYearMonth.atDay(day)}" 
                             th:classappend="${currentYearMonth.atDay(day).isBefore(currentDate) ? 'day-disabled' : ''}">
                            <span class="day-number" th:text="${day}"></span>
                            <div class="day-appointments">
                                <th:block th:each="appointment : ${monthAppointments}">
                                    <div th:if="${appointment.appointmentDateTime != null and #temporals.format(appointment.appointmentDateTime, 'yyyy-MM-dd') == currentYearMonth.atDay(day).toString()}" 
                                         class="appointment-indicator"
                                         th:classappend="${appointment.isPaid ? 'paid' : (appointment.status == 'Confirmed' ? 'confirmed' : 'pending')}"
                                         th:title="${appointment.serviceName + ' - ' + appointment.pet.nome}">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>
            
            <div id="appointment-form" style="display: none; margin-top: 20px;">
                <div class="appointment-grid">
                    <div class="services-list-container">
                        <h3 class="subsection-title">Selecionar Serviço</h3>
                        
                        <div class="service-option" data-service-name="Banho" data-price="25">
                            <div class="service-icon-circle"><i class="fas fa-bath"></i></div>
                            <div class="service-details">
                                <h4>Banho</h4>
                                <p>Banho relaxante com produtos premium</p>
                                <div class="service-meta">
                                    <span><i class="fas fa-clock"></i> 45-60 min</span>
                                    <span class="price-tag editable" data-service="Banho" contenteditable="true">25€</span>
                                </div>
                            </div>
                        </div>

                        <div class="service-option" data-service-name="Banho e Tosquia Intima" data-price="35">
                            <div class="service-icon-circle"><i class="fas fa-cut"></i></div>
                            <div class="service-details">
                                <h4>Banho e Tosquia Íntima</h4>
                                <p>Banho completo + tosquia higiénica</p>
                                <div class="service-meta">
                                    <span><i class="fas fa-clock"></i> 60-90 min</span>
                                    <span class="price-tag editable" data-service="Banho e Tosquia Intima" contenteditable="true">35€</span>
                                </div>
                            </div>
                        </div>

                        <div class="service-option" data-service-name="Banho e Tosquia Geral" data-price="50">
                            <div class="service-icon-circle"><i class="fas fa-star"></i></div>
                            <div class="service-details">
                                <h4>Banho e Tosquia Geral</h4>
                                <p>Pacote completo com tosquia adaptada à raça</p>
                                <div class="service-meta">
                                    <span><i class="fas fa-clock"></i> 90-120 min</span>
                                    <span class="price-tag editable" data-service="Banho e Tosquia Geral" contenteditable="true">50€</span>
                                </div>
                            </div>
                        </div>

                        <div class="service-option" data-service-name="Pet Sitting" data-price="30">
                            <div class="service-icon-circle"><i class="fas fa-home"></i></div>
                            <div class="service-details">
                                <h4>Pet Sitting</h4>
                                <p>Cuidado personalizado na casa do cliente</p>
                                <div class="service-meta">
                                    <span><i class="fas fa-calendar"></i> Por período</span>
                                    <span class="price-tag editable" data-service="Pet Sitting" contenteditable="true">30€/dia</span>
                                </div>
                            </div>
                        </div>

                        <div class="service-option" data-service-name="Hosting" data-price="40">
                            <div class="service-icon-circle"><i class="fas fa-bed"></i></div>
                            <div class="service-details">
                                <h4>Hosting</h4>
                                <p>Hospedagem nas nossas instalações</p>
                                <div class="service-meta">
                                    <span><i class="fas fa-calendar"></i> Por período</span>
                                    <span class="price-tag editable" data-service="Hosting" contenteditable="true">40€/dia</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-container">
                        <form action="/admin/appointment/save" method="post" id="admin-appointment-form">
                            <h3 class="subsection-title">Detalhes do Agendamento</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label><strong>Pet:</strong></label>
                                <input type="text" id="pet-search" placeholder="Digite o nome do pet..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px;">
                                <div id="pet-results" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
                                <input type="hidden" id="selected-pet-id" name="petId" required>
                                <div id="selected-pet-display" style="padding: 8px; background: #f8f9fa; border-radius: 4px; display: none;"></div>
                            </div>
                            
                            <div id="single-date-section">
                                <div style="margin-bottom: 15px;">
                                    <label><strong>Data:</strong></label>
                                    <input type="date" id="selected-date" name="selectedDate" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label><strong>Horário:</strong></label>
                                    <div class="time-slots" id="timeSlots">
                                        <button type="button" class="time-slot" data-time-value="09:00">09:00</button>
                                        <button type="button" class="time-slot" data-time-value="10:00">10:00</button>
                                        <button type="button" class="time-slot" data-time-value="11:00">11:00</button>
                                        <button type="button" class="time-slot" data-time-value="14:00">14:00</button>
                                        <button type="button" class="time-slot" data-time-value="15:00">15:00</button>
                                        <button type="button" class="time-slot" data-time-value="16:00">16:00</button>
                                    </div>
                                    <input type="hidden" id="selected-time" name="selectedTime">
                                </div>
                            </div>
                            
                            <div id="date-range-section" style="display: none;">
                                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <label><strong>Data Início:</strong></label>
                                        <input type="date" id="start-date" name="startDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label><strong>Data Fim:</strong></label>
                                        <input type="date" id="end-date" name="endDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label><strong>Observações:</strong></label>
                                    <textarea name="observations" rows="3" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; resize: vertical;" placeholder="Informações adicionais..."></textarea>
                                </div>
                            </div>
                            
                            <input type="hidden" id="service-name" name="serviceName">
                            <input type="hidden" id="service-price" name="servicePrice">
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" id="save-appointment" disabled>
                                    <i class="fas fa-save"></i> Salvar Agendamento
                                </button>
                                <button type="button" onclick="hideAppointmentForm()" class="btn" style="background: #6c757d; color: white;">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Admin Calendar JavaScript
let allPets = [];

document.addEventListener('DOMContentLoaded', function() {
    loadPets();
    initServiceSelection();
    initTimeSlots();
    initPetSearch();
});

function loadPets() {
    fetch('/api/pets/all')
        .then(response => response.json())
        .then(data => {
            allPets = data;
        })
        .catch(error => console.error('Erro ao carregar pets:', error));
}

function initServiceSelection() {
    const serviceOptions = document.querySelectorAll('.service-option');
    
    serviceOptions.forEach(option => {
        option.addEventListener('click', function() {
            serviceOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            const serviceName = this.getAttribute('data-service-name');
            const isRangeService = serviceName === 'Pet Sitting' || serviceName === 'Hosting';
            
            document.getElementById('service-name').value = serviceName;
            document.getElementById('service-price').value = this.getAttribute('data-price');
            
            if (isRangeService) {
                document.getElementById('single-date-section').style.display = 'none';
                document.getElementById('date-range-section').style.display = 'block';
            } else {
                document.getElementById('single-date-section').style.display = 'block';
                document.getElementById('date-range-section').style.display = 'none';
            }
            
            validateForm();
        });
    });
    
    // Preços editáveis
    const editablePrices = document.querySelectorAll('.price-tag.editable');
    editablePrices.forEach(price => {
        price.addEventListener('blur', function() {
            const service = this.getAttribute('data-service');
            const newPrice = this.textContent.replace('€', '').replace('/dia', '');
            console.log(`Preço do ${service} alterado para: ${newPrice}`);
        });
    });
}

function initTimeSlots() {
    const timeSlots = document.querySelectorAll('.time-slot');
    
    timeSlots.forEach(slot => {
        slot.addEventListener('click', function() {
            timeSlots.forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('selected-time').value = this.getAttribute('data-time-value');
            validateForm();
        });
    });
}

function initPetSearch() {
    const searchInput = document.getElementById('pet-search');
    const resultsDiv = document.getElementById('pet-results');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        
        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        const filteredPets = allPets.filter(pet => 
            pet.nome.toLowerCase().includes(query)
        );
        
        if (filteredPets.length > 0) {
            resultsDiv.innerHTML = filteredPets.map(pet => 
                `<div class="pet-result" onclick="selectPet(${pet.id}, '${pet.nome}', '${pet.tutorName}')" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;">
                    <strong>${pet.nome}</strong> <span style="color: #666; font-weight: normal;">- ${pet.tutorName}</span>
                </div>`
            ).join('');
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.style.display = 'none';
        }
    });
}

function selectPet(petId, petName, tutorName) {
    document.getElementById('selected-pet-id').value = petId;
    document.getElementById('pet-search').value = '';
    document.getElementById('pet-results').style.display = 'none';
    
    const displayDiv = document.getElementById('selected-pet-display');
    displayDiv.innerHTML = `<strong>${petName}</strong> <span style="color: #666;">- ${tutorName}</span>`;
    displayDiv.style.display = 'block';
    
    validateForm();
}

function validateForm() {
    const petId = document.getElementById('selected-pet-id').value;
    const serviceName = document.getElementById('service-name').value;
    const selectedDate = document.getElementById('selected-date').value;
    const selectedTime = document.getElementById('selected-time').value;
    const startDate = document.getElementById('start-date').value;
    
    const isRangeService = serviceName === 'Pet Sitting' || serviceName === 'Hosting';
    const isValid = petId && serviceName && 
        (isRangeService ? startDate : (selectedDate && selectedTime));
    
    document.getElementById('save-appointment').disabled = !isValid;
}

function showAppointmentForm() {
    document.getElementById('appointment-form').style.display = 'block';
}

function hideAppointmentForm() {
    document.getElementById('appointment-form').style.display = 'none';
    // Reset form
    document.getElementById('admin-appointment-form').reset();
    document.querySelectorAll('.service-option').forEach(opt => opt.classList.remove('selected'));
    document.getElementById('selected-pet-display').style.display = 'none';
}

function generateReport(type) {
    const url = type === 'pdf' ? '/admin/reports/pdf' : '/admin/reports/excel';
    window.open(url, '_blank');
}
</script>

<style>
.editable {
    cursor: pointer;
    border: 1px dashed transparent;
    padding: 2px 4px;
    border-radius: 3px;
}

.editable:hover {
    border-color: #ddd;
    background: #f8f9fa;
}

.pet-result:hover {
    background: #f8f9fa;
}

.service-option.selected {
    border: 2px solid var(--color-primary);
    box-shadow: 0 0 0 3px rgba(254, 135, 160, 0.2);
}

.time-slot.selected {
    background-color: var(--color-primary) !important;
    color: white !important;
}
</style>

<script src="/js/script.js"></script>
</body>
</html>